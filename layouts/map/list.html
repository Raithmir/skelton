{{ define "main" }}

{{/* Build location data from all relevant content types */}}
{{ $locations := slice }}
{{ $geocache := $.Site.Data.geocache | default dict }}

{{ range where $.Site.RegularPages "Type" "business" }}
  {{ if not .Draft }}
    {{ $addr := .Params.address | default "" }}
    {{ if $addr }}
      {{ $query := printf "%s, Leeds, UK" $addr }}
      {{ $loc := dict "title" .Title "type" "business" "category" (.Params.category | default "") "query" $query "url" .Permalink }}
      {{ with index $geocache $query }}{{ $loc = merge $loc (dict "lat" .lat "lng" .lng) }}{{ end }}
      {{ $locations = $locations | append $loc }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range where $.Site.RegularPages "Type" "amenity" }}
  {{ if not .Draft }}
    {{ $addr := .Params.address | default "" }}
    {{ $pc := .Params.postcode | default "" }}
    {{ $query := cond (ne $pc "") (printf "%s %s, UK" $addr $pc) (printf "%s, Leeds, UK" $addr) }}
    {{ if $addr }}
      {{ $loc := dict "title" .Title "type" "amenity" "category" (.Params.category | default "") "query" $query "url" .Permalink }}
      {{ with index $geocache $query }}{{ $loc = merge $loc (dict "lat" .lat "lng" .lng) }}{{ end }}
      {{ $locations = $locations | append $loc }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range where $.Site.RegularPages "Type" "healthcare" }}
  {{ if not .Draft }}
    {{ $addr := .Params.address | default "" }}
    {{ $pc := .Params.postcode | default "" }}
    {{ $query := cond (ne $pc "") (printf "%s %s, UK" $addr $pc) (printf "%s, Leeds, UK" $addr) }}
    {{ if $addr }}
      {{ $loc := dict "title" .Title "type" "healthcare" "category" (.Params.category | default "") "query" $query "url" .Permalink }}
      {{ with index $geocache $query }}{{ $loc = merge $loc (dict "lat" .lat "lng" .lng) }}{{ end }}
      {{ $locations = $locations | append $loc }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range where $.Site.RegularPages "Type" "school" }}
  {{ if not .Draft }}
    {{ $addr := .Params.address | default "" }}
    {{ $pc := .Params.postcode | default "" }}
    {{ $query := cond (ne $pc "") (printf "%s %s, UK" $addr $pc) (printf "%s, Leeds, UK" $addr) }}
    {{ if $addr }}
      {{ $loc := dict "title" .Title "type" "school" "category" (.Params.category | default "") "query" $query "url" .Permalink }}
      {{ with index $geocache $query }}{{ $loc = merge $loc (dict "lat" .lat "lng" .lng) }}{{ end }}
      {{ $locations = $locations | append $loc }}
    {{ end }}
  {{ end }}
{{ end }}

<article class="max-w-full">
  <header class="mb-6">
    <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700 border-b-4 border-primary-600 p-6 mb-2">
      <div class="flex items-center gap-3 mb-2">
        <svg class="w-8 h-8 text-primary-600 dark:text-primary-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
        </svg>
        <h1 class="text-4xl font-bold text-neutral-900 dark:text-neutral-100">Estate Map</h1>
      </div>
      <p class="text-lg text-neutral-700 dark:text-neutral-300">
        Businesses, amenities, healthcare and schools near Skelton Gate. Click any marker for details.
      </p>
    </div>
  </header>

  <!-- Legend -->
  <div class="mb-4 flex flex-wrap items-center" style="gap:0.75rem">
    <span class="text-sm font-semibold text-neutral-700 dark:text-neutral-300">Map key:</span>
    <span class="flex items-center text-sm text-neutral-700 dark:text-neutral-300">
      <span class="inline-block w-3 h-3 rounded-full mr-1" style="background:#2563EB"></span>Business
    </span>
    <span class="flex items-center text-sm text-neutral-700 dark:text-neutral-300">
      <span class="inline-block w-3 h-3 rounded-full mr-1" style="background:#16a34a"></span>Amenity
    </span>
    <span class="flex items-center text-sm text-neutral-700 dark:text-neutral-300">
      <span class="inline-block w-3 h-3 rounded-full mr-1" style="background:#dc2626"></span>Healthcare
    </span>
    <span class="flex items-center text-sm text-neutral-700 dark:text-neutral-300">
      <span class="inline-block w-3 h-3 rounded-full mr-1" style="background:#7c3aed"></span>School
    </span>
  </div>

  <!-- Loading indicator -->
  <div id="map-loading" class="mb-2 text-sm text-neutral-600 dark:text-neutral-400" style="display:none">
    Loading markers: <span id="map-progress">0</span> / <span id="map-total">0</span>
    <span class="ml-2 text-xs">(cached after first load)</span>
  </div>

  <!-- Map container -->
  <div id="map" style="height:560px;border-radius:0.5rem;overflow:hidden" class="mb-6"></div>

  <!-- Note about geocoding -->
  <p class="text-xs text-neutral-500 dark:text-neutral-500">
    Location data provided by <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener" class="underline hover:text-neutral-700">OpenStreetMap</a> contributors via Nominatim. Marker positions are geocoded from addresses and may not be perfectly precise.
  </p>
</article>

<!-- Location data from Hugo -->
<script>
const LOCATIONS = {{ $locations | jsonify | safeJS }};
</script>

<!-- Leaflet JS + map init -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
  const CACHE_KEY = 'sg_geocode_v2';
  const MARKER_COLORS = {
    business:   '#2563EB',
    amenity:    '#16a34a',
    healthcare: '#dc2626',
    school:     '#7c3aed'
  };

  function makeIcon(color) {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36">
      <path d="M12 0C5.373 0 0 5.373 0 12c0 9 12 24 12 24s12-15 12-24C24 5.373 18.627 0 12 0z" fill="${color}" stroke="white" stroke-width="1.5"/>
      <circle cx="12" cy="12" r="5" fill="white"/>
    </svg>`;
    return L.divIcon({
      html: svg,
      className: '',
      iconSize: [24, 36],
      iconAnchor: [12, 36],
      popupAnchor: [0, -36]
    });
  }

  function categoryLabel(type, cat) {
    if (!cat) return type.charAt(0).toUpperCase() + type.slice(1);
    return cat.charAt(0).toUpperCase() + cat.slice(1);
  }

  // Initialise map centred on Skelton Gate / east Leeds
  const map = L.map('map').setView([53.786, -1.479], 12);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Load cache
  let cache = {};
  try { cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}'); } catch(e) {}

  function saveCache() {
    try { localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); } catch(e) {}
  }

  const bounds = [];
  let loaded = 0;
  const total = LOCATIONS.length;

  const loadingEl  = document.getElementById('map-loading');
  const progressEl = document.getElementById('map-progress');
  const totalEl    = document.getElementById('map-total');

  // Split into pre-geocoded, localStorage-cached, and uncached
  const uncached = [];
  LOCATIONS.forEach(function(loc) {
    if (loc.lat && loc.lng) {
      // Coordinates embedded at build time â€” instant, no API call needed
      addMarker(loc, {lat: loc.lat, lng: loc.lng});
      loaded++;
    } else if (cache[loc.query]) {
      addMarker(loc, cache[loc.query]);
      loaded++;
    } else {
      uncached.push(loc);
    }
  });

  if (uncached.length > 0) {
    loadingEl.style.display = 'block';
    totalEl.textContent = total;
    progressEl.textContent = loaded;
    geocodeQueue(uncached, 0);
  } else {
    fitBounds();
  }

  function geocodeQueue(queue, idx) {
    if (idx >= queue.length) {
      loadingEl.style.display = 'none';
      fitBounds();
      return;
    }
    const loc = queue[idx];
    const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(loc.query);
    fetch(url, { headers: { 'Accept-Language': 'en' } })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data && data[0]) {
          const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
          cache[loc.query] = coords;
          saveCache();
          addMarker(loc, coords);
        }
        loaded++;
        progressEl.textContent = loaded;
        setTimeout(function() { geocodeQueue(queue, idx + 1); }, 1100);
      })
      .catch(function() {
        loaded++;
        progressEl.textContent = loaded;
        setTimeout(function() { geocodeQueue(queue, idx + 1); }, 1100);
      });
  }

  function addMarker(loc, coords) {
    const color = MARKER_COLORS[loc.type] || '#6b7280';
    const marker = L.marker([coords.lat, coords.lng], { icon: makeIcon(color) }).addTo(map);
    const label = categoryLabel(loc.type, loc.category);
    marker.bindPopup(
      '<div style="min-width:160px">' +
      '<p style="font-weight:600;margin:0 0 4px">' + escHtml(loc.title) + '</p>' +
      '<p style="font-size:0.75rem;color:#6b7280;margin:0 0 8px">' + escHtml(label) + '</p>' +
      '<a href="' + escHtml(loc.url) + '" style="font-size:0.8rem;color:#2563EB;text-decoration:underline">View details</a>' +
      '</div>'
    );
    bounds.push([coords.lat, coords.lng]);
  }

  function fitBounds() {
    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
    }
  }

  function escHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
})();
</script>
{{ end }}
